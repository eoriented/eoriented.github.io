<!DOCTYPE html>

<html lang="ko-KR">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>Smart Tiger&#39;s blog</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://eoriented.github.io/apple-touch-icon.png">
    
    
    <link rel="icon" type="image/png" sizes="16x16" href="https://eoriented.github.io/favicon.ico">
    <link rel="manifest" href="https://eoriented.github.io/manifest.json">
    <link rel="mask-icon" href="https://eoriented.github.io/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://eoriented.github.io/css/main.min.832f51bd8886edde2e4bd3034bec7fb7bb6766151b4f7c83987458ed1481c80f.css"/>

    
    
    

    
    
 
    
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-160052384-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
  });
  MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script> 
</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        
        <a href="https://eoriented.github.io/">
        <img style="display: block; margin: 0px auto" width="90%" src="https://eoriented.github.io/images/logo2.png" /></a>
    </div>  
</header>
  <div class="nav-menu">
  
    <a class="color-link nav-link" href="https://eoriented.github.io/categories/bigdata/">Big data</a>
  
    <a class="color-link nav-link" href="https://eoriented.github.io/categories/machine-learning/">Machine learning</a>
  
    <a class="color-link nav-link" href="https://eoriented.github.io/categories/programming/">Programming</a>
  
    <a class="color-link nav-link" href="https://eoriented.github.io/categories/cloud/">Cloud</a>
  
    <a class="color-link nav-link" href="https://eoriented.github.io/categories/tools/">Tools</a>
  
    <a class="color-link nav-link" href="https://eoriented.github.io/categories/">Categories</a>
  
    <a class="color-link nav-link" href="https://eoriented.github.io/tags/">Tags</a>
  
  
</div>
<footer class="footer">
	<div class="social-icons" style="text-align: center">
    
    <a class="social-icon" href="https://github.com/eoriented" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    

    
    <a class="social-icon" href="mailto:eoriented@gmail.com" target="_blank" rel="noopener" title="Email">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M25.2794292,5.59128519 L14,16.8707144 L2.72057081,5.59128519 C3.06733103,5.30237414 3.51336915,5.12857603 4,5.12857603 L24,5.12857603 C24.4866308,5.12857603 24.932669,5.30237414 25.2794292,5.59128519 Z M25.9956978,6.99633695 C25.998551,7.04004843 26,7.08414302 26,7.12857603 L26,20.871424 C26,21.0798433 25.9681197,21.2808166 25.9089697,21.4697335 L18.7156355,14.2763993 L25.9956978,6.99633695 Z M24.9498374,22.6319215 C24.6672737,22.7846939 24.3437653,22.871424 24,22.871424 L4,22.871424 C3.5268522,22.871424 3.09207889,22.7071233 2.74962118,22.432463 L10.0950247,15.0870594 L13.9848068,18.9768415 L14.1878486,18.7737996 L14.2030419,18.7889929 L17.6549753,15.3370594 L24.9498374,22.6319215 Z M2.00810114,21.0526627 C2.00273908,20.9929669 2,20.9325153 2,20.871424 L2,7.12857603 C2,7.08414302 2.00144896,7.04004843 2.00430222,6.99633695 L9.03436454,14.0263993 L2.00810114,21.0526627 Z"></path>
        </svg>
    </a>
    

    
    <a class="social-icon" href="https://eoriented.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml" title="Rss">
        <svg width="28px" height="28px" viewBox="0 0 8 8" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <circle xmlns="http://www.w3.org/2000/svg" class="symbol" cx="2" cy="6" r="1"/>
            <path xmlns="http://www.w3.org/2000/svg" class="symbol" d="m 1,4 a 3,3 0 0 1 3,3 h 1 a 4,4 0 0 0 -4,-4 z"/>
            <path xmlns="http://www.w3.org/2000/svg" class="symbol" d="m 1,2 a 5,5 0 0 1 5,5 h 1 a 6,6 0 0 0 -6,-6 z"/>
        </svg>
    </a>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    

    
</div>




	
	

	<script src="https://eoriented.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">저장소(Storage)와 검색(Retrieval) - 3</h1>
    
    <div>
        <p>
        <p><a href="https://eoriented.github.io/post/storage-and-retrieval-2/">이전 포스트</a>에 이어서 세 번째 포스트입니다. 이전 포스트에서는 SS테이블과 LSM 트리에 관해 알아보았습니다. 이번 포스트에서는 데이터베이스에서 가장 많이 사용하고 일반적인 색인 유형인 B 트리에 대해서 살펴보겠습니다.</p>
<h2 id="b-트리">B 트리</h2>
<p>B 트리는 거의 대부분의 관계형 데이터베이스에서 표준 색인 구현으로 사용할 뿐만 아니라 비관계형 데이터에서도 사용합니다. B트리는 SS테이블과 같이 키로 정렬된 key-value 쌍을 유지하지 때문에 key-value 검색과 range query에 효율적입니다. 이와 같이 LSM 트리와는 유사한 점은 이게 다이고 B 트리의 설계 철학은 매우 다릅니다.</p>
<p>LSM 트리는 일반적으로 수 메가바이트 이상의 가변 크기를 가진 세그먼트를 나누고 순차적으로 세그먼트를 기록합니다. 반면 B 트리는 전통적으로 4KB 크기의 고정 크기 블록이나 페이지로 나누고 한번에 하나의 페이지에 읽기 또는 쓰기를 합니다. 이와 같이 고정 크기 블록을 사용하는 이유는 디스크가 고정 크기 블록으로 배열되어 있기 때문입니다. 즉 하드웨어와의 관련성 때문입니다.</p>
<p>다음 그림은 B 트리를 이용한 키를 검색하는 방법을 나타내는 그림입니다.</p>
<figure >
<a href="https://notes.shichao.io/dda/ch3/" target="_blank">
  <img src="https://eoriented.github.io/images/storage-and-retrieval-3/b-tree-retrieval.png" width="100%"  style="max-width: 650px" />
  </a>

</figure>
<p>색인에서 원하는 키를 찾으려면 루트에서부터 시작합니다. 위의 그림은 user_id 251을 찾고 있기 때문에 200과 300 사이의 페이지의 참조를 따라갑니다. 그 다음 250과 270 사이에 참조를 따라가서 최종적으로 leaf 페이지에 도달하고 252의 값을 찾습니다.</p>
<p>B 트리의 하나의 페이지에서 하위 페이지를 참조하는 수를 분기 계수(branching factor)라고 합니다. 위의 그림에서는 분기 계수가 6입니다. 실제로 분기 계수는 보통 수백 개에 달합니다.</p>
<p>B 트리에 존재하는 키의 값을 update 하려면 리프 페이지까지 검색한 후에 페이지에 있는 값을 변경 후 디스크에 다시 씁니다. 새로운 키를 추가하려면 아래의 그림과 같이 새로운 키를 포함하는 범위의 페이지를 찾아 해당 페이지에 키와 값을 추가합니다. 만일 쓰려고 하는 페이지에 여유 공간이 없으면 페이지를 둘로 나누고 상위 페이지가 새로운 키 범위를 가진 하위 페이지들을 알 수 있게 갱신한 후 추가합니다.</p>
<figure >

  <img src="https://eoriented.github.io/images/storage-and-retrieval-3/split-b-tree.png" width="100%"  style="max-width: 650px" />
  

</figure>
<p>이 알고리즘은 트리가 계속 균형을 유지하는 것을 보장합니다. 대부분의 데이터베이스는 B 트리의 깊이가 4단계 정도면 충분하므로 검색하려는 페이지를 찾기 위해 많은 페이지 참조를 따라가지 않아도 됩니다. 분기 계수가 500이고 페이지 크기가 4KB이면서 깊이가 4단계인 트리는 256TB(500^4 * 4096 = 256TB)까지 저장할 수 있습니다.</p>
<h2 id="신뢰할-수-있는-b-트리-만들기">신뢰할 수 있는 B 트리 만들기</h2>
<p>B 트리의 기본적인 쓰기 동작은 새로운 데이터를 디스크에 덮어쓰는 것입니다. 그러나 삽입 때문에 페이지가 너무 많아져 페이지를 나눠야 한다면 분할된 두 페이지를 기록하고 두 하위 페이지의 참조를 갱신하도록 상위 페이지를 덮어써야 합니다. 만일 일부 페이지만 기록하고 데이터베이스에 장애가 발생한다면 색인이 훼손됩니다. 이렇게 색인이 훼손되면 고아 페이지(orphan page)가 발생할 수 있습니다. 고아 페이지란 어떤 페이지와도 부모 관계가 없는 페이지를 이야기합니다.</p>
<p>이렇게 데이터베이스의 장애가 발생한 상황에서도 스스로 복구할 수 있도록 하기 위해서 일반적으로 디스크에 write-ahead log(WAL)라고 하는 데이터 구조를 추가해 B 트리를 구현합니다. WAL은 트리 페이지에 변경된 내용을 적용하기 전에 모든 B 트리의 변경사항을 기록하는 append-only 파일입니다. 이 로그를 통해 데이터베이스 장애 이후 복구될 때 일관성있는 상태로 B 트리를 다시 복원합니다.</p>
<p>또한 다중 스레드가 동시에 B 트리에 접근한다면 주의 깊게 동시성 제어를 해야 합니다. 그렇지 않다면 스레드가 일관성이 깨진 상태의 트리에 접근할 수도 있기 때문입니다. 동시성 제어는 보통 latch(가벼운 잠금(lock))으로 트리 데이터 구조를 보호합니다.</p>
<h2 id="b-트리와-lsm-트리-비교">B 트리와 LSM 트리 비교</h2>
<p>경험적으로 LSM 트리는 보통 쓰기에서 더 빠른 반면 B 트리는 읽기에서 더 빠릅니다. LSM 트리가 읽기가 더 느린 이유는 각 컴팩션 단계에 여러 데이터 구조와 SS 테이블을 확인해야 하기 때문입니다.</p>
<h2 id="lsm-트리의-장단점">LSM 트리의 장단점</h2>
<p>데이터베이스에 쓰기 한 번이 디스크에 여러번 쓰는 효과를 write amplification이라고 합니다. 상대적으로 LSM 트리가 상대적으로 쓰기 증폭이 B 트리보다 낮고 트리에서 여러 페이지를 덮어 쓰는 것이 아닌 순차적으로 컴팩션된 SS 테이블 파일을 쓰기 때문에 더 높은 쓰기 처리량을 유지할 수 있습니다. 또한 압축률이 더 좋습니다.</p>
<p>단점으로는 컴팩션 과정으로 인해 읽기와 쓰기 성능에 영향을 줄 수 있다는 점입니다. 쓰기 처리량이 높아도 디스크의 쓰기 대역폭은 유한하기 때문입니다. 또한 B 트리의 경우 각 키가 색인의 한 곳에만 정확히 존재하지만 로그 구조화 저장소 엔진은 다른 세그먼트에 같은 키를 가지는 여러 복사본이 존재할 수 있습니다. 이러한 이유 때문에 강력한 트랜잭션을 제공하는 데이터베이스에는 B 트리가 매력적입니다.</p>
<p>이번 포스트에서는 B 트리를 통한 색인 방법과 B트리와 LSM 트리를 비교하여 살펴보았습니다. 다음 포스트에서는 이어서 온라인 트랜잭션 처리(OLTP)와 온라인 분석 처리(OLAP)을 비교하여 살펴볼 예정입니다.</p>

        </p>

        <br />
        <br />

        <div class="paging post-paging" style="margin-bottom: 15px;">
            
            
            <div style="text-align: left">
                <a class="left" href="https://eoriented.github.io/post/storage-and-retrieval-2/" rel="prev" style="color: #64BEA3">
                    <i class="fa fa-play fa-rotate-180" aria-hidden="true"></i>&nbsp;&nbsp;<span>저장소(Storage)와 검색(Retrieval) - 2</span>
                </a>
            </div>
            
            
            
        </div>
    </div>

    
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "smart-tiger" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="https://eoriented.github.io/tags/b-tree">#b-tree</a>
        
            <a class="tag" href="https://eoriented.github.io/tags/lsm-tree">#LSM tree</a>
        
            <a class="tag" href="https://eoriented.github.io/tags/%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%B2%A0%EC%9D%B4%EC%8A%A4">#데이터베이스</a>
        
            <a class="tag" href="https://eoriented.github.io/tags/%EC%83%89%EC%9D%B8">#색인</a>
        
            <a class="tag" href="https://eoriented.github.io/tags/%EB%8D%B0%EC%9D%B4%ED%84%B0%EC%A0%80%EC%9E%A5%EC%86%8C">#데이터저장소</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons" style="text-align: center">
    
    <a class="social-icon" href="https://github.com/eoriented" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    

    
    <a class="social-icon" href="mailto:eoriented@gmail.com" target="_blank" rel="noopener" title="Email">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M25.2794292,5.59128519 L14,16.8707144 L2.72057081,5.59128519 C3.06733103,5.30237414 3.51336915,5.12857603 4,5.12857603 L24,5.12857603 C24.4866308,5.12857603 24.932669,5.30237414 25.2794292,5.59128519 Z M25.9956978,6.99633695 C25.998551,7.04004843 26,7.08414302 26,7.12857603 L26,20.871424 C26,21.0798433 25.9681197,21.2808166 25.9089697,21.4697335 L18.7156355,14.2763993 L25.9956978,6.99633695 Z M24.9498374,22.6319215 C24.6672737,22.7846939 24.3437653,22.871424 24,22.871424 L4,22.871424 C3.5268522,22.871424 3.09207889,22.7071233 2.74962118,22.432463 L10.0950247,15.0870594 L13.9848068,18.9768415 L14.1878486,18.7737996 L14.2030419,18.7889929 L17.6549753,15.3370594 L24.9498374,22.6319215 Z M2.00810114,21.0526627 C2.00273908,20.9929669 2,20.9325153 2,20.871424 L2,7.12857603 C2,7.08414302 2.00144896,7.04004843 2.00430222,6.99633695 L9.03436454,14.0263993 L2.00810114,21.0526627 Z"></path>
        </svg>
    </a>
    

    
    <a class="social-icon" href="https://eoriented.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml" title="Rss">
        <svg width="28px" height="28px" viewBox="0 0 8 8" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <circle xmlns="http://www.w3.org/2000/svg" class="symbol" cx="2" cy="6" r="1"/>
            <path xmlns="http://www.w3.org/2000/svg" class="symbol" d="m 1,4 a 3,3 0 0 1 3,3 h 1 a 4,4 0 0 0 -4,-4 z"/>
            <path xmlns="http://www.w3.org/2000/svg" class="symbol" d="m 1,2 a 5,5 0 0 1 5,5 h 1 a 6,6 0 0 0 -6,-6 z"/>
        </svg>
    </a>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    

    
</div>




	
		
		
		
	

	<script src="https://eoriented.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>