<!DOCTYPE html>

<html lang="ko-KR">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>Smart Tiger&#39;s blog</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://eoriented.github.io/apple-touch-icon.png">
    
    
    <link rel="icon" type="image/png" sizes="16x16" href="https://eoriented.github.io/favicon.ico">
    <link rel="manifest" href="https://eoriented.github.io/manifest.json">
    <link rel="mask-icon" href="https://eoriented.github.io/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://eoriented.github.io/css/main.min.a61a6dbd5fa5e67d72c4b5f927e5fb9dee8dd9fddcb176cfdef138e99de4d8f9.css"/>

    
    
    

    
    
 
    
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-160052384-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
  });
  MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script> 
</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        
        <a href="https://eoriented.github.io/">
        <img style="display: block; margin: 0px auto" width="90%" src="https://eoriented.github.io/images/logo2.png" /></a>
    </div>  
</header>
  <div class="nav-menu">
  
    <a class="color-link nav-link" href="https://eoriented.github.io/categories/bigdata/">Big data</a>
  
    <a class="color-link nav-link" href="https://eoriented.github.io/categories/machine-learning/">Machine learning</a>
  
    <a class="color-link nav-link" href="https://eoriented.github.io/categories/programming/">Programming</a>
  
    <a class="color-link nav-link" href="https://eoriented.github.io/categories/cloud/">Cloud</a>
  
    <a class="color-link nav-link" href="https://eoriented.github.io/categories/tools/">Tools</a>
  
    <a class="color-link nav-link" href="https://eoriented.github.io/categories/">Categories</a>
  
    <a class="color-link nav-link" href="https://eoriented.github.io/tags/">Tags</a>
  
  
</div>
<footer class="footer">
	<div class="social-icons" style="text-align: center">
    
    <a class="social-icon" href="https://github.com/eoriented" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    

    
    <a class="social-icon" href="mailto:eoriented@gmail.com" target="_blank" rel="noopener" title="Email">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M25.2794292,5.59128519 L14,16.8707144 L2.72057081,5.59128519 C3.06733103,5.30237414 3.51336915,5.12857603 4,5.12857603 L24,5.12857603 C24.4866308,5.12857603 24.932669,5.30237414 25.2794292,5.59128519 Z M25.9956978,6.99633695 C25.998551,7.04004843 26,7.08414302 26,7.12857603 L26,20.871424 C26,21.0798433 25.9681197,21.2808166 25.9089697,21.4697335 L18.7156355,14.2763993 L25.9956978,6.99633695 Z M24.9498374,22.6319215 C24.6672737,22.7846939 24.3437653,22.871424 24,22.871424 L4,22.871424 C3.5268522,22.871424 3.09207889,22.7071233 2.74962118,22.432463 L10.0950247,15.0870594 L13.9848068,18.9768415 L14.1878486,18.7737996 L14.2030419,18.7889929 L17.6549753,15.3370594 L24.9498374,22.6319215 Z M2.00810114,21.0526627 C2.00273908,20.9929669 2,20.9325153 2,20.871424 L2,7.12857603 C2,7.08414302 2.00144896,7.04004843 2.00430222,6.99633695 L9.03436454,14.0263993 L2.00810114,21.0526627 Z"></path>
        </svg>
    </a>
    

    
    <a class="social-icon" href="https://eoriented.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml" title="Rss">
        <svg width="28px" height="28px" viewBox="0 0 8 8" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <circle xmlns="http://www.w3.org/2000/svg" class="symbol" cx="2" cy="6" r="1"/>
            <path xmlns="http://www.w3.org/2000/svg" class="symbol" d="m 1,4 a 3,3 0 0 1 3,3 h 1 a 4,4 0 0 0 -4,-4 z"/>
            <path xmlns="http://www.w3.org/2000/svg" class="symbol" d="m 1,2 a 5,5 0 0 1 5,5 h 1 a 6,6 0 0 0 -6,-6 z"/>
        </svg>
    </a>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    

    
</div>




	
	

	<script src="https://eoriented.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">이벤트 시간 처리(Event Time Processing)와 워터마크(Watermark) - (feat. Apache Flink)</h1>
    
    <div>
        <p>
        <p>스트림 처리에서 바라보는 시간적 측면 중에 <strong>이벤트 시간(Event time)</strong> 기반으로 처리하는 방식에 대해 살펴보겠습니다. 최근에 데이터 처리 분야에서 스트리밍 애플리케이션 개발의 중요성이 더욱 커지고 있습니다. 만약 스트리밍 애플리케이션을 개발하게 되는 경우 애플리케이션의 목적에 따라 이벤트 시간(Event time)을 기준으로 처리할 것인지 처리 시간(Processing time) 기준으로 처리할 것인지 선택을 해야 할 것입니다. 각각의 시간이 갖는 특성을 이해하고 있으면 스트리밍 애플리케이션의 요구사항에 알맞는 시간을 선택하여 개발할 수 있을 것입니다.</p>
<h2 id="스트림-처리에서-바라보는-시간">스트림 처리에서 바라보는 시간</h2>
<ul>
<li>이벤트 시간(event time)
<ul>
<li>이벤트 시간이란 데이터에 의존적인 타임스탬프입니다. 즉, 데이터 내에 존재하는 데이터 발생 시간과 같은 것입니다. 데이터에 의존적이기 때문에 어떠한 값을 타임스탬프로 넣을 것인지 다르겠지만 주로 이벤트가 발생한 시간을 많이 사용합니다.</li>
</ul>
</li>
<li>처리 시간(processing time)
<ul>
<li>처리 시간이란 실제 스트림 처리 엔진에서 데이터를 처리하는 시간입니다. 즉, 해당 데이터를 받아 처리할 때 처리하는 서버의 시간입니다.</li>
</ul>
</li>
<li>수집 시간(ingestion time)
<ul>
<li>스트림 처리 엔진에 데이터가 처음으로 수집된, 즉, 들어온 시간을 나타냅니다.</li>
</ul>
</li>
</ul>
<p>글로만 보았을 때는 헷깔리는 부분이 있습니다. 다음 그림을 보면 이해하기 쉬울 것입니다.</p>
<figure >
<a href="https://www.slideshare.net/dataArtisans/apache-flink-training-time-and-watermarks" target="_blank">
  <img src="https://eoriented.github.io/images/event-time-processing-and-watermark/time.png" width="100%"  style="max-width: 650px" />
  </a>

</figure>
<p>스트림에서 바라보는 시간들이 잘 구별되어 있습니다. 이 중에 이벤트 시간과 처리 시간이 가장 많이 사용됩니다. 스토리지 시간(Storage time)의 경우 많이 사용되진 않습니다.</p>
<p>이벤트 시간은 위에서 설명했듯이 실세계에서 발생한 이벤트의 시간이고 처리 시간은 스트림 시스템에서 이벤트를 처리한 시간입니다. 포스트의 제목처럼 이벤트 시간 처리의 이해도를 높이기 위해서 먼저 처리 시간 기반의 시스템에 대해 살펴보겠습니다. 이 포스트에선 따로 스트림 처리에서 사용하는 윈도우의 개념에 대해서는 설명하지 않습니다. 윈도우에 대한 개념은 본 블로그 내에 있는 <a href="https://eoriented.github.io/post/stream-processing-2/">스트림 프로세싱</a> 포스트에서 확인하실 수 있습니다.</p>
<h2 id="처리-시간-기반-시스템">처리 시간 기반 시스템</h2>
<p>처리 시간 기반 시스템의 예제는 윈도우 사이즈가 10이고 5초마다 슬라이딩 되어 윈도우가 처리됩니다. 본 예제는 간단히 윈도우 내에서 키를 기준으로 워드 카운트를 하는 예제입니다. 플링크 기반의 예제로 설명을 하는데 대부분의 스트림 처리 엔진에서도 비슷한 방식의 연산들을 제공합니다.</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#007020;font-weight:bold">val</span> senv <span style="color:#007020;font-weight:bold">=</span> <span style="color:#0e84b5;font-weight:bold">StreamExecutionEnvironment</span><span style="color:#666">.</span>getExecutionEnvironment
<span style="color:#007020;font-weight:bold">val</span> text <span style="color:#007020;font-weight:bold">=</span> env<span style="color:#666">.</span>socketTextStream<span style="color:#666">(</span><span style="color:#4070a0">&#34;localhost&#34;</span><span style="color:#666">,</span> <span style="color:#40a070">9999</span><span style="color:#666">)</span>

<span style="color:#007020;font-weight:bold">val</span> counts <span style="color:#007020;font-weight:bold">=</span> text<span style="color:#666">.</span>map <span style="color:#666">{(</span>m<span style="color:#007020;font-weight:bold">:</span> <span style="color:#902000">String</span><span style="color:#666">)</span> <span style="color:#007020;font-weight:bold">=&gt;</span> <span style="color:#666">(</span>m<span style="color:#666">.</span>split<span style="color:#666">(</span><span style="color:#4070a0">&#34;,&#34;</span><span style="color:#666">)(</span><span style="color:#40a070">0</span><span style="color:#666">),</span> <span style="color:#40a070">1</span><span style="color:#666">)</span> <span style="color:#666">}</span>
    <span style="color:#666">.</span>keyBy<span style="color:#666">(</span><span style="color:#40a070">0</span><span style="color:#666">)</span>
    <span style="color:#666">.</span>timeWindow<span style="color:#666">(</span><span style="color:#0e84b5;font-weight:bold">Time</span><span style="color:#666">.</span>seconds<span style="color:#666">(</span><span style="color:#40a070">10</span><span style="color:#666">),</span> <span style="color:#0e84b5;font-weight:bold">Time</span><span style="color:#666">.</span>seconds<span style="color:#666">(</span><span style="color:#40a070">5</span><span style="color:#666">))</span>
    <span style="color:#666">.</span>sum<span style="color:#666">(</span><span style="color:#40a070">1</span><span style="color:#666">)</span>

counts<span style="color:#666">.</span>print
senv<span style="color:#666">.</span>execute<span style="color:#666">(</span><span style="color:#4070a0">&#34;ProcessingTime example&#34;</span><span style="color:#666">)</span>
</code></pre></div><p>이 예제에서 메시지가 정시에 도착하는 경우와 메시지가 지연이 발생해서 늦게 도착하는 경우를 나누어서 사례를 살펴보겠습니다. 본 예제에서는 아래의 그림과 같이 3개의 메세지에 대한 처리를 합니다. 메시지는 CSV 형태이며 <code>value,eventTime</code>의 문자열입니다. 첫 번째는 13초에 <code>a</code>라는 키를 가진 이벤트가 2개 발생하고 16초에 1개 발생합니다.</p>
<figure >
<a href="http://vishnuviswanath.com/flink_eventtime.html" target="_blank">
  <img src="https://eoriented.github.io/images/event-time-processing-and-watermark/event-generation.png" width="100%"  style="max-width: 650px" />
  </a>

</figure>
<h3 id="메시지가-정시에-도착하는-경우">메시지가 정시에 도착하는 경우</h3>
<p>위의 소스 코드에서 처럼 윈도우 사이즈는 10이며 5초마다 슬라이딩 됩니다. 메시지 지연이 없는 경우 아래의 그림과 같이 처리가 됩니다.</p>
<figure >
<a href="http://vishnuviswanath.com/flink_eventtime.html" target="_blank">
  <img src="https://eoriented.github.io/images/event-time-processing-and-watermark/processing-without-delay.png" width="100%"  style="max-width: 650px" />
  </a>

</figure>
<p>일반적으로 개발자는 메시지를 위의 그림과 같이 처리하기를 기대합니다. 그러나 메시지는 네트워크 끊김과 같은 상황으로 인해 지연될 수 있습니다. 그럼 메시지가 시스템에 지연되어 도착하는 경우 처리 시간 기반 시스템에선 어떻게 처리되는지 살펴보겠습니다.</p>
<h3 id="메시지가-지연이-발생해서-늦게-도착하는-경우">메시지가 지연이 발생해서 늦게 도착하는 경우</h3>
<p>13초에 발생한 메시지가 6초의 지연이 발생하여 19초에 도착했다라고 가정해봅시다. 그러면 처리 시간 기반 시스템에서는 어떻게 처리될까요? 바로 다음과 같이 처리가 될 것입니다.</p>
<figure >
<a href="http://vishnuviswanath.com/flink_eventtime.html" target="_blank">
  <img src="https://eoriented.github.io/images/event-time-processing-and-watermark/processing-with-delay.png" width="100%"  style="max-width: 650px" />
  </a>

</figure>
<p>위의 그림에서 처럼 첫 번째 윈도우의 키 합의 결과가 1이되고 윈도우 3의 결과가 2가 되어 우리가 기대했던 결과와 다른 형태로 처리가 되었습니다. 이와 같이 메시지 지연이 발생하는 경우 우리가 기대했던 결과값과 다른 결과가 나올 수 있습니다. 그럼 이 문제는 어떻게 해결해야 할까요? 이러한 문제를 해결하기 위해서는 처리 시간을 사용하는 것이 아닌 이벤트 시간 기준으로 처리해야 합니다.</p>
<h2 id="이벤트-시간-기반-처리-시스템">이벤트 시간 기반 처리 시스템</h2>
<p>이벤트 시간은 메시지가 생성된 시간이 대표적입니다. 그러나 스트림 처리 시스템에서는 데이터에서 어떤 것이 이벤트 시간인지 알 수 없습니다. 그래서 데이터 내에 시간 부분을 추출하는 방법을 알려줘야 합니다. 플링크에서는 이벤트 시간을 추출하는 클래스를 정의해주어야 합니다. 정의하는 방법은 다음과 같습니다.</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">TimestampExtractor</span> <span style="color:#007020;font-weight:bold">extends</span> <span style="color:#0e84b5;font-weight:bold">AssignerWithPeriodicWatermarks</span><span style="color:#666">[</span><span style="color:#902000">String</span><span style="color:#666">]</span> <span style="color:#007020;font-weight:bold">with</span> <span style="color:#0e84b5;font-weight:bold">Serializable</span> <span style="color:#666">{</span>
  <span style="color:#007020;font-weight:bold">override</span> <span style="color:#007020;font-weight:bold">def</span> extractTimestamp<span style="color:#666">(</span>e<span style="color:#007020;font-weight:bold">:</span> <span style="color:#902000">String</span><span style="color:#666">,</span> prevElementTimestamp<span style="color:#007020;font-weight:bold">:</span> <span style="color:#902000">Long</span><span style="color:#666">)</span> <span style="color:#007020;font-weight:bold">=</span> <span style="color:#666">{</span>
    e<span style="color:#666">.</span>split<span style="color:#666">(</span><span style="color:#4070a0">&#34;,&#34;</span><span style="color:#666">)(</span><span style="color:#40a070">1</span><span style="color:#666">).</span>toLong 
  <span style="color:#666">}</span>

  <span style="color:#007020;font-weight:bold">override</span> <span style="color:#007020;font-weight:bold">def</span> getCurrentWatermark<span style="color:#666">()</span><span style="color:#007020;font-weight:bold">:</span> <span style="color:#902000">Watermark</span> <span style="color:#666">=</span> <span style="color:#666">{</span> 
    <span style="color:#007020;font-weight:bold">new</span> <span style="color:#0e84b5;font-weight:bold">Watermark</span><span style="color:#666">(</span><span style="color:#0e84b5;font-weight:bold">System</span><span style="color:#666">.</span>currentTimeMillis<span style="color:#666">)</span>
  <span style="color:#666">}</span>
<span style="color:#666">}</span>
</code></pre></div><p>위의 코드와 같이 이벤트 시간 추출기를 정의해줍니다. 실제 이벤트 시간 추출은 <code>extractTimestamp</code>라는 메소드에서 처리되서 나온 결과로 사용합니다. <code>getCurrentWatermark</code> 메소드는 뒤에서 설명드리도록 하겠습니다. 이제 이벤트 시간을 기반으로 하는 스트림 애플리케이션을 작성해보겠습니다.</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#007020;font-weight:bold">val</span> senv <span style="color:#007020;font-weight:bold">=</span> <span style="color:#0e84b5;font-weight:bold">StreamExecutionEnvironment</span><span style="color:#666">.</span>getExecutionEnvironment
senv<span style="color:#666">.</span>setStreamTimeCharacteristic<span style="color:#666">(</span><span style="color:#0e84b5;font-weight:bold">TimeCharacteristic</span><span style="color:#666">.</span><span style="color:#0e84b5;font-weight:bold">EventTime</span><span style="color:#666">)</span>

<span style="color:#007020;font-weight:bold">val</span> text <span style="color:#007020;font-weight:bold">=</span> senv<span style="color:#666">.</span>socketTextStream<span style="color:#666">(</span><span style="color:#4070a0">&#34;localhost&#34;</span><span style="color:#666">,</span> <span style="color:#40a070">9999</span><span style="color:#666">)</span>
                <span style="color:#666">.</span>assignTimestampsAndWatermarks<span style="color:#666">(</span><span style="color:#007020;font-weight:bold">new</span> <span style="color:#0e84b5;font-weight:bold">TimestampExtractor</span><span style="color:#666">)</span> 

<span style="color:#007020;font-weight:bold">val</span> counts <span style="color:#007020;font-weight:bold">=</span> text<span style="color:#666">.</span>map <span style="color:#666">{(</span>m<span style="color:#007020;font-weight:bold">:</span> <span style="color:#902000">String</span><span style="color:#666">)</span> <span style="color:#007020;font-weight:bold">=&gt;</span> <span style="color:#666">(</span>m<span style="color:#666">.</span>split<span style="color:#666">(</span><span style="color:#4070a0">&#34;,&#34;</span><span style="color:#666">)(</span><span style="color:#40a070">0</span><span style="color:#666">),</span> <span style="color:#40a070">1</span><span style="color:#666">)</span> <span style="color:#666">}</span>
      <span style="color:#666">.</span>keyBy<span style="color:#666">(</span><span style="color:#40a070">0</span><span style="color:#666">)</span>
      <span style="color:#666">.</span>timeWindow<span style="color:#666">(</span><span style="color:#0e84b5;font-weight:bold">Time</span><span style="color:#666">.</span>seconds<span style="color:#666">(</span><span style="color:#40a070">10</span><span style="color:#666">),</span> <span style="color:#0e84b5;font-weight:bold">Time</span><span style="color:#666">.</span>seconds<span style="color:#666">(</span><span style="color:#40a070">5</span><span style="color:#666">))</span>
      <span style="color:#666">.</span>sum<span style="color:#666">(</span><span style="color:#40a070">1</span><span style="color:#666">)</span>

counts<span style="color:#666">.</span>print
senv<span style="color:#666">.</span>execute<span style="color:#666">(</span><span style="color:#4070a0">&#34;EventTime example&#34;</span><span style="color:#666">)</span>
</code></pre></div><p>이벤트 시간을 기반으로 처리하는 경우 <code>TimeCharacteristic</code>을 <code>EventTime</code>으로 설정합니다. 그리고 스트림 소스에 이벤트 시간 추출기를 셋팅해주었습니다. 그 외의 로직 코드는 동일합니다. 자, 그럼 위의 코드를 사용하는 경우 메세지 지연이 발생했을 때 어떻게 처리가 되는지 한번 살펴보겠습니다.</p>
<figure >
<a href="http://vishnuviswanath.com/flink_eventtime.html" target="_blank">
  <img src="https://eoriented.github.io/images/event-time-processing-and-watermark/event-with-delay.png" width="100%"  style="max-width: 650px" />
  </a>

</figure>
<p>메세지 지연이 발생하는 경우 처리 시간 기반 시스템과의 결과가 다릅니다. 이벤트 시간 기반 처리에서는 윈도우 3에서 지연된 메시지의 이벤트 시간이 맞지 않기 때문에 포함되지 않은 결과를 올바르게 내보냅니다. 하지만 여전히 윈도우 1의 결과는 우리가 기대하는 결과값과 다릅니다. 윈도우 1의 완료 시간은 15초인데 메시지는 이미 윈도우가 완료된 후인 19초에 들어왔기 때문입니다. 이렇게 메시지 지연으로 윈도우 1에서 처리해야 할 메시지를 처리하지 못한 것입니다. 이러한 문제를 해결하기 위해서 워터마크(Watermark)라는 기능을 사용합니다.</p>
<h2 id="워터마크watermark">워터마크(Watermark)</h2>
<p>워터마크는 이러한 지연된 메세지를 처리하기 위한 흥미로운 아이디어입니다. 워터마크는 하나의 타임스탬프입니다. 이 워터마크를 통해 플링크에서는 워터마크보다 지연된 메시지는 도착하지 않을 것이라고 가정하고 결과를 처리합니다. 이러한 워터마크의 개념은 플링크 뿐만 아니라 다른 스트림 시스템에서도 이와 같이 지연된 메시지를 처리하는 방법으로 제공하고 있습니다.
우리는 이미 위의 예제에서 워터마크를 설정하는 것을 확인하였습니다. 바로 이벤트 시간 추출기에서 워터마크에 관한 정보도 함께 지정해주었습니다. 이제 워터마크를 통해서 위에서 지연된 메시지를 정상적으로 처리하는 방법에 관해 살펴보겠습니다.</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#007020;font-weight:bold">override</span> <span style="color:#007020;font-weight:bold">def</span> getCurrentWatermark<span style="color:#666">()</span><span style="color:#007020;font-weight:bold">:</span> <span style="color:#902000">Watermark</span> <span style="color:#666">=</span> <span style="color:#666">{</span> 
  <span style="color:#007020;font-weight:bold">new</span> <span style="color:#0e84b5;font-weight:bold">Watermark</span><span style="color:#666">(</span><span style="color:#0e84b5;font-weight:bold">System</span><span style="color:#666">.</span>currentTimeMillis <span style="color:#666">-</span> <span style="color:#40a070">5000</span><span style="color:#666">)</span>
<span style="color:#666">}</span>
</code></pre></div><p>시간 추출기 클래스에서 워터마크 설정을 <code>(현재 시간 - 5초)</code>로 설정하겠습니다. 이렇게 설정하게 되면 시스템에게 메시지의 지연 시간을 5초까지는 허용하겠다고 알려주는 것입니다. 이와 같이 설정이 되면 위에서 윈도우 1 <code>[5초 - 15초]</code>의 결과는 20초에 나오게 됩니다. 마찬가지로 윈도우 2 <code>[10초 - 20초]</code>는 5초 뒤인 25초에 결과가 나오게 됩니다.</p>
<figure >
<a href="http://vishnuviswanath.com/flink_eventtime.html" target="_blank">
  <img src="https://eoriented.github.io/images/event-time-processing-and-watermark/event-handle-delay.png" width="100%"  style="max-width: 650px" />
  </a>

</figure>
<p>이와 같이 워터마크를 사용하여 지연된 메시지를 받은 경우에도 정상적으로 결과를 만들어 내도록 처리하였습니다.</p>
<p>이번 포스트에서 스트림 시스템에서 사용되는 시간의 종류에 대해 살펴보았습니다. 그리고 그 시간을 기반으로 메시지가 어떻게 처리되는지도 함께 알아보았습니다. 스트림 시스템에서 메세지 지연은 어쩔 수 없이 발생합니다. 이러한 메세지 지연을 처리하기 위해서 워터마크라는 기능을 제공합니다. 스트림 애플리케이션을 개발할 때 애플리케이션에서 메시지 지연을 허용할 지, 혹은 지연된 메시지를 그냥 무시할 것인지는 요구사항에 따라 다릅니다. 그래서 개발하려는 애플리케이션의 특성을 정확히 파악하고 특성에 맞도록 메시지를 처리하도록 해야 합니다.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://www.youtube.com/watch?v=3UfZN59Nsk8">Dataflow: A Unified Model for Batch and Streaming Data Processing</a></li>
<li><a href="http://vishnuviswanath.com/flink_eventtime.html">http://vishnuviswanath.com/flink_eventtime.html</a></li>
<li><a href="https://www.slideshare.net/dataArtisans/apache-flink-training-time-and-watermarks">https://www.slideshare.net/dataArtisans/apache-flink-training-time-and-watermarks</a></li>
<li><a href="https://softwaremill.com/windowing-in-big-data-streams-spark-flink-kafka-akka/">https://softwaremill.com/windowing-in-big-data-streams-spark-flink-kafka-akka/</a></li>
</ul>

        </p>

        <br />
        <br />

        <div class="paging post-paging" style="margin-bottom: 15px;">
            
            
        </div>
    </div>

    
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "smart-tiger" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="https://eoriented.github.io/tags/%ED%94%8C%EB%A7%81%ED%81%AC">#플링크</a>
        
            <a class="tag" href="https://eoriented.github.io/tags/event-time">#event time</a>
        
            <a class="tag" href="https://eoriented.github.io/tags/prcessing-time">#prcessing time</a>
        
            <a class="tag" href="https://eoriented.github.io/tags/ingestion-time">#ingestion time</a>
        
            <a class="tag" href="https://eoriented.github.io/tags/storage-time">#storage time</a>
        
            <a class="tag" href="https://eoriented.github.io/tags/window">#window</a>
        
            <a class="tag" href="https://eoriented.github.io/tags/sliding-window">#sliding window</a>
        
            <a class="tag" href="https://eoriented.github.io/tags/tumbling-window">#tumbling window</a>
        
            <a class="tag" href="https://eoriented.github.io/tags/watermark">#watermark</a>
        
            <a class="tag" href="https://eoriented.github.io/tags/%EC%9B%8C%ED%84%B0%EB%A7%88%ED%81%AC">#워터마크</a>
        
            <a class="tag" href="https://eoriented.github.io/tags/lateness">#lateness</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons" style="text-align: center">
    
    <a class="social-icon" href="https://github.com/eoriented" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    

    
    <a class="social-icon" href="mailto:eoriented@gmail.com" target="_blank" rel="noopener" title="Email">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M25.2794292,5.59128519 L14,16.8707144 L2.72057081,5.59128519 C3.06733103,5.30237414 3.51336915,5.12857603 4,5.12857603 L24,5.12857603 C24.4866308,5.12857603 24.932669,5.30237414 25.2794292,5.59128519 Z M25.9956978,6.99633695 C25.998551,7.04004843 26,7.08414302 26,7.12857603 L26,20.871424 C26,21.0798433 25.9681197,21.2808166 25.9089697,21.4697335 L18.7156355,14.2763993 L25.9956978,6.99633695 Z M24.9498374,22.6319215 C24.6672737,22.7846939 24.3437653,22.871424 24,22.871424 L4,22.871424 C3.5268522,22.871424 3.09207889,22.7071233 2.74962118,22.432463 L10.0950247,15.0870594 L13.9848068,18.9768415 L14.1878486,18.7737996 L14.2030419,18.7889929 L17.6549753,15.3370594 L24.9498374,22.6319215 Z M2.00810114,21.0526627 C2.00273908,20.9929669 2,20.9325153 2,20.871424 L2,7.12857603 C2,7.08414302 2.00144896,7.04004843 2.00430222,6.99633695 L9.03436454,14.0263993 L2.00810114,21.0526627 Z"></path>
        </svg>
    </a>
    

    
    <a class="social-icon" href="https://eoriented.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml" title="Rss">
        <svg width="28px" height="28px" viewBox="0 0 8 8" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <circle xmlns="http://www.w3.org/2000/svg" class="symbol" cx="2" cy="6" r="1"/>
            <path xmlns="http://www.w3.org/2000/svg" class="symbol" d="m 1,4 a 3,3 0 0 1 3,3 h 1 a 4,4 0 0 0 -4,-4 z"/>
            <path xmlns="http://www.w3.org/2000/svg" class="symbol" d="m 1,2 a 5,5 0 0 1 5,5 h 1 a 6,6 0 0 0 -6,-6 z"/>
        </svg>
    </a>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    

    
</div>




	
		
		
		
	

	<script src="https://eoriented.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>